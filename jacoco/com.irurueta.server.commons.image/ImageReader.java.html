<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImageReader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">com.irurueta:irurueta-server-commons-image</a> &gt; <a href="index.source.html" class="el_package">com.irurueta.server.commons.image</a> &gt; <span class="el_source">ImageReader.java</span></div><h1>ImageReader.java</h1><pre class="source lang-java linenums">/**
 * Copyright (C) 2016 Alberto Irurueta Carro (alberto@irurueta.com)
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.irurueta.server.commons.image;

import static com.irurueta.server.commons.image.ImageOrientation.LEFT_BOTTOM;
import static com.irurueta.server.commons.image.ImageOrientation.RIGHT_TOP;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.ref.SoftReference;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.zip.CRC32;
import org.apache.commons.codec.binary.Base64;
import org.apache.sanselan.ImageInfo;
import org.apache.sanselan.ImageReadException;
import org.apache.sanselan.Sanselan;
import org.apache.sanselan.common.RationalNumber;
import org.apache.sanselan.formats.jpeg.JpegImageMetadata;
import org.apache.sanselan.formats.tiff.TiffField;
import org.apache.sanselan.formats.tiff.constants.ExifTagConstants;
import org.apache.sanselan.formats.tiff.constants.TiffConstants;
import org.apache.sanselan.formats.tiff.constants.TiffTagConstants;
import org.apache.sanselan.formats.tiff.fieldtypes.FieldTypeRational;
import org.apache.sanselan.formats.tiff.fieldtypes.FieldTypeShort;

/**
 * Class to read image metadata.
 */
public class ImageReader {
    /**
     * Constant indicating if CRC is computed by default.
     */
    public static final boolean DEFAULT_COMPUTE_CRC = true;
    
    /**
     * Constant indicating if MD5 hash is computed by default.
     */
    public static final boolean DEFAULT_COMPUTE_MD5 = true;
    
    /**
     * Buffer size to compute CRC and MD5.
     */
    public static final int BUFFER_SIZE = 1024;
    
    /**
     * Reference to singleton instance of this class.
     */
    private static SoftReference&lt;ImageReader&gt; mReference;
    
    /**
     * Indicates if CRC will be computed when reading image metadata.
     */
<span class="fc" id="L68">    private volatile boolean mComputeCrc = DEFAULT_COMPUTE_CRC;</span>
    
    /**
     * Indicates if MD5 will be computed when reading image metadata.
     */
<span class="fc" id="L73">    private volatile boolean mComputeMd5 = DEFAULT_COMPUTE_MD5;</span>
        
    /**
     * Constructor.
     */
<span class="fc" id="L78">    private ImageReader() { }</span>
    
    /**
     * Factory method. Creates or returns singleton instance.
     * @return singleton instance.
     */
    public static synchronized ImageReader getInstance() {
        ImageReader reader;
<span class="pc bpc" id="L86" title="1 of 4 branches missed.">        if (mReference == null || (reader = mReference.get()) == null) {</span>
<span class="fc" id="L87">            reader = new ImageReader();</span>
<span class="fc" id="L88">            mReference = new SoftReference&lt;&gt;(reader);</span>
        }
<span class="fc" id="L90">        return reader;</span>
    }
    
    /**
     * Indicates if CRC computation is enabled.
     * @return true if CRC computation is enabled, false otherwise.
     */
    public synchronized boolean isComputeCrcEnabled() {
<span class="fc" id="L98">        return mComputeCrc;</span>
    }
    
    /**
     * Specifies whether CRC computation is enabled.
     * @param computeCrc true if CRC computation must be enabled, false 
     * otherwise.
     */
    public synchronized void setComputeCrcEnabled(boolean computeCrc) {
<span class="fc" id="L107">        this.mComputeCrc = computeCrc;</span>
<span class="fc" id="L108">    }</span>
    
    /**
     * Indicates if MD5 hash computation is enabled.
     * @return true if MD5 computation is enabled, false otherwise.
     */
    public synchronized boolean isComputeMd5Enabled() {
<span class="fc" id="L115">        return mComputeMd5;</span>
    }
    
    /**
     * Specifies whether MD5 hash computation is enabled.
     * @param computeMd5 true if MD5 computation must be enabled, false 
     * otherwise.
     */
    public synchronized void setComputeMd5Enabled(boolean computeMd5) {
<span class="fc" id="L124">        this.mComputeMd5 = computeMd5;</span>
<span class="fc" id="L125">    }</span>
    
    /**
     * Reads image metadata from provided image file.
     * @param f file containing an image in one of the supported formats (jpg,
     * png, gif or bmp).
     * @return result containing image metadata and image file information.
     * @throws InvalidImageException throws if file is corrupted, contains 
     * invalid data, is not an image or format is not supported.
     * @throws IOException if an I/O error occurs.
     */
    public ImageReaderResult readImage(File f) throws InvalidImageException, 
            IOException {
        try {
<span class="fc" id="L139">            ImageReaderResult result = new ImageReaderResult();</span>
<span class="fc" id="L140">            ImageInfo imageInfo = Sanselan.getImageInfo(f);</span>
<span class="fc" id="L141">            result.setValid(internalCheckValid(imageInfo));</span>
<span class="fc" id="L142">            result.setFileLength(f.length());</span>
<span class="fc" id="L143">            result.setLastModified(f.lastModified());</span>
            
            //Read metadata
<span class="fc" id="L146">            result.setContentType(imageInfo.getMimeType());</span>
<span class="fc" id="L147">            result.setImageFormat(getImageFormat(imageInfo));</span>
            
<span class="fc" id="L149">            ImageMetadata metadata = new ImageMetadata();</span>
<span class="fc" id="L150">            result.setMetadata(metadata);</span>
            
            //if file is JPEG read its exif data
<span class="fc bfc" id="L153" title="All 2 branches covered.">            if (imageInfo.getFormat() == </span>
                    org.apache.sanselan.ImageFormat.IMAGE_FORMAT_JPEG) {
<span class="fc" id="L155">                internalReadExif(f, imageInfo, metadata);</span>
            } else {
                //if not, at least set image size so we can generate thumbnails
<span class="fc" id="L158">                metadata.setWidth(imageInfo.getWidth());</span>
<span class="fc" id="L159">                metadata.setHeight(imageInfo.getHeight());</span>
            }            
        
<span class="fc" id="L162">            computeCRCandMd5(f, result);</span>
<span class="fc" id="L163">            return result;</span>
<span class="nc" id="L164">        } catch (ImageReadException e) {</span>
<span class="nc" id="L165">            throw new InvalidImageException(e);</span>
        }
    }
    
    /**
     * Check if valid is one of the supported image formats.
     * @param f an image file.
     * @return true if file appears to be valid, false otherwise.
     * @throws InvalidImageException if image file is corrupted.
     * @throws IOException if an I/O error occurs.
     */
    public static boolean checkValidFile(File f) throws InvalidImageException, 
            IOException {
        try {
<span class="nc" id="L179">            ImageInfo imageInfo = Sanselan.getImageInfo(f);</span>
<span class="nc" id="L180">            return internalCheckValid(imageInfo);</span>
<span class="nc" id="L181">        } catch (IOException e) {</span>
<span class="nc" id="L182">            throw e;</span>
<span class="nc" id="L183">        } catch (Throwable t) {</span>
<span class="nc" id="L184">            throw new InvalidImageException(t);</span>
        }
    }
    
    /**
     * Computes CRC and MD5 hashes for provided file and the results get stored
     * in provided result instance.
     * @param f file to compute CRC and MD5 hashes.
     * @param result instance where CRC and MD5 will be stored.
     * @throws IOException if an I/O error occurs.
     */
    private void computeCRCandMd5(File f, ImageReaderResult result) 
            throws IOException {
<span class="pc bpc" id="L197" title="2 of 4 branches missed.">        if (f == null || result == null) {</span>
<span class="nc" id="L198">            return;</span>
        }
        
<span class="fc" id="L201">        try (InputStream stream = new FileInputStream(f)) {</span>
<span class="fc" id="L202">            CRC32 crc = null;</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">            if (mComputeCrc) {</span>
<span class="fc" id="L204">                crc = new CRC32();</span>
            }

<span class="fc" id="L207">            MessageDigest digest = null;</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">            if (mComputeMd5) {</span>
                try {
<span class="fc" id="L210">                    digest = MessageDigest.getInstance(&quot;MD5&quot;);</span>
<span class="fc" id="L211">                    digest.reset();</span>
<span class="nc" id="L212">                } catch (NoSuchAlgorithmException e) {</span>
<span class="nc" id="L213">                    digest = null;</span>
<span class="fc" id="L214">                }</span>
            }

            
<span class="fc" id="L218">            byte [] buffer = new byte[BUFFER_SIZE];</span>
            int n;
<span class="fc bfc" id="L220" title="All 2 branches covered.">            while ((n = stream.read(buffer)) &gt; 0) {</span>
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">                if (crc != null) {</span>
<span class="fc" id="L222">                    crc.update(buffer, 0, n);</span>
                }
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">                if (digest != null) {</span>
<span class="fc" id="L225">                    digest.update(buffer, 0, n);</span>
                }
            }
            
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">            if (crc != null) {</span>
<span class="fc" id="L230">                result.setCrc(crc.getValue());</span>
            }
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">            if (digest != null) {</span>
<span class="fc" id="L233">                result.setMd5(Base64.encodeBase64String(digest.digest()));</span>
            }            
        }
<span class="fc" id="L236">    }</span>
                
    /**
     * Determines image format for a given image file.
     * @param imageInfo structure containing metadata of image file being read.
     * @return detected image format.
     */
    private com.irurueta.server.commons.image.ImageFormat getImageFormat(
            ImageInfo imageInfo) {
<span class="fc" id="L245">        org.apache.sanselan.ImageFormat format = imageInfo.getFormat();</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">        if (format == org.apache.sanselan.ImageFormat.IMAGE_FORMAT_JPEG) {</span>
<span class="fc" id="L247">            return com.irurueta.server.commons.image.ImageFormat.JPEG;</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">        } else if (format == org.apache.sanselan.ImageFormat.IMAGE_FORMAT_PNG) {</span>
<span class="fc" id="L249">            return com.irurueta.server.commons.image.ImageFormat.PNG;</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">        } else if (format == org.apache.sanselan.ImageFormat.IMAGE_FORMAT_GIF) {</span>
<span class="nc" id="L251">            return com.irurueta.server.commons.image.ImageFormat.GIF;</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">        } else if (format == org.apache.sanselan.ImageFormat.IMAGE_FORMAT_BMP) {</span>
<span class="fc" id="L253">            return com.irurueta.server.commons.image.ImageFormat.BMP;</span>
        } else {
<span class="nc" id="L255">            return com.irurueta.server.commons.image.ImageFormat.UNKNOWN;</span>
        }
    }
    
    /**
     * Indicates if image file corresponds to one of the supported image 
     * formats.
     * @param imageInfo structure containing metadata of image file being read.
     * @return if image file has one of the supported formats.
     */
    private static boolean internalCheckValid(ImageInfo imageInfo) {
<span class="fc" id="L266">        org.apache.sanselan.ImageFormat format = imageInfo.getFormat();</span>
<span class="pc bpc" id="L267" title="2 of 8 branches missed.">        return format == org.apache.sanselan.ImageFormat.IMAGE_FORMAT_JPEG ||</span>
                format == org.apache.sanselan.ImageFormat.IMAGE_FORMAT_PNG ||
                format == org.apache.sanselan.ImageFormat.IMAGE_FORMAT_GIF ||
                format == org.apache.sanselan.ImageFormat.IMAGE_FORMAT_BMP;
    }   
    
    /**
     * Internal method in charge of reading image metadata and EXIF tags.
     * @param f image file.
     * @param imageInfo structure containing metadata of image file being read.
     * @param result structure where resulting image metadata will be stored.
     * @throws InvalidImageException if image file is corrupted or not 
     * supported.
     * @throws IOException if an I/O error occurs.
     */
    private void internalReadExif(File f, ImageInfo imageInfo, 
            ImageMetadata result) throws InvalidImageException, IOException {
        
        try {
            //store image size
<span class="fc" id="L287">            result.setWidth(imageInfo.getWidth());</span>
<span class="fc" id="L288">            result.setHeight(imageInfo.getHeight());</span>
            
<span class="fc" id="L290">            JpegImageMetadata metadata = </span>
<span class="fc" id="L291">                    (JpegImageMetadata)Sanselan.getMetadata(f);</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">            if (metadata == null) {</span>
<span class="fc" id="L293">                return;</span>
            }
            
            //Get maker
<span class="fc" id="L297">            TiffField makerField = metadata.findEXIFValue(</span>
                    TiffTagConstants.TIFF_TAG_MAKE);
<span class="fc" id="L299">            String maker = null;</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">            if (makerField != null) {</span>
<span class="fc" id="L301">                maker = makerField.getValueDescription();</span>
            }
<span class="fc bfc" id="L303" title="All 2 branches covered.">            if (maker != null) {</span>
<span class="fc" id="L304">                result.setMaker(trim(maker));</span>
            }
                
            //Get model
<span class="fc" id="L308">            TiffField modelField = metadata.findEXIFValue(</span>
                    TiffTagConstants.TIFF_TAG_MODEL);
<span class="fc" id="L310">            String model = null;</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">            if (modelField != null) {</span>
<span class="fc" id="L312">                model = modelField.getValueDescription();</span>
            }
<span class="fc bfc" id="L314" title="All 2 branches covered.">            if (model != null) {</span>
<span class="fc" id="L315">                result.setModel(trim(model));</span>
            }
            
            //Focal length
<span class="fc" id="L319">            TiffField focalLengthField = metadata.findEXIFValue(</span>
                    TiffConstants.EXIF_TAG_FOCAL_LENGTH);
<span class="pc bpc" id="L321" title="1 of 4 branches missed.">            if (focalLengthField != null &amp;&amp; </span>
                    focalLengthField.fieldType instanceof FieldTypeRational) {
<span class="fc" id="L323">                RationalNumber number = </span>
<span class="fc" id="L324">                        (RationalNumber)focalLengthField.getValue();</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L326">                    result.setFocalLength(number.doubleValue());</span>
                }
            }
            
            //Focal plane x resolution
<span class="fc" id="L331">            TiffField focalPlaneXResolutionField = metadata.findEXIFValue(</span>
                    TiffConstants.EXIF_TAG_FOCAL_PLANE_XRESOLUTION);
<span class="pc bpc" id="L333" title="3 of 4 branches missed.">            if (focalPlaneXResolutionField != null &amp;&amp;</span>
                    focalPlaneXResolutionField.fieldType instanceof FieldTypeRational) {
<span class="nc" id="L335">                RationalNumber number =</span>
<span class="nc" id="L336">                        (RationalNumber)focalPlaneXResolutionField.getValue();</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                if (number != null) {</span>
<span class="nc" id="L338">                    result.setFocalPlaneXResolution(number.doubleValue());</span>
                }
            }

            //Focal plane y resolution
<span class="fc" id="L343">            TiffField focalPlaneYResolutionField = metadata.findEXIFValue(</span>
                    TiffConstants.EXIF_TAG_FOCAL_PLANE_YRESOLUTION);
<span class="pc bpc" id="L345" title="3 of 4 branches missed.">            if (focalPlaneYResolutionField != null &amp;&amp;</span>
                    focalPlaneYResolutionField.fieldType instanceof FieldTypeRational) {
<span class="nc" id="L347">                RationalNumber number =</span>
<span class="nc" id="L348">                        (RationalNumber)focalPlaneYResolutionField.getValue();</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                if (number != null) {</span>
<span class="nc" id="L350">                    result.setFocalPlaneYResolution(number.doubleValue());</span>
                }
            }
            
            //Focal plane resolution unit
<span class="fc" id="L355">            TiffField focalPlaneResolutionUnitField = metadata.findEXIFValue(</span>
                    TiffConstants.EXIF_TAG_FOCAL_PLANE_RESOLUTION_UNIT);
<span class="pc bpc" id="L357" title="3 of 4 branches missed.">            if (focalPlaneResolutionUnitField != null &amp;&amp; </span>
                    focalPlaneResolutionUnitField.fieldType instanceof FieldTypeShort) {
<span class="nc" id="L359">                Integer number = </span>
<span class="nc" id="L360">                        (Integer)focalPlaneResolutionUnitField.getValue();</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                if (number != null) {</span>
<span class="nc" id="L362">                    result.setFocalPlaneResolutionUnit(Unit.fromValue(number));</span>
                }
            }
            
            //Orientation
<span class="fc" id="L367">            TiffField orientationField = metadata.findEXIFValue(</span>
                    TiffConstants.EXIF_TAG_ORIENTATION);
<span class="pc bpc" id="L369" title="2 of 4 branches missed.">            if (orientationField != null &amp;&amp;</span>
                    orientationField.fieldType instanceof FieldTypeShort) {
<span class="fc" id="L371">                Integer number = (Integer)orientationField.getValue();</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L373">                    result.setOrientation(ImageOrientation.fromValue(number));</span>
                }
            }
            
            //gps latitude
<span class="fc" id="L378">            Double latitude = null;</span>
<span class="fc" id="L379">            TiffField gpsLatitudeField = metadata.findEXIFValue(</span>
                    TiffConstants.GPS_TAG_GPS_LATITUDE);
<span class="fc bfc" id="L381" title="All 4 branches covered.">            if (gpsLatitudeField != null &amp;&amp;</span>
                    gpsLatitudeField.fieldType instanceof FieldTypeRational) {
<span class="fc" id="L383">                RationalNumber gpsLatitude[] = </span>
<span class="fc" id="L384">                        (RationalNumber[])gpsLatitudeField.getValue();</span>
                
<span class="pc bpc" id="L386" title="2 of 4 branches missed.">                if (gpsLatitude != null &amp;&amp; gpsLatitude.length &gt;= 3) {</span>
<span class="fc" id="L387">                    RationalNumber gpsLatitudeDegrees = gpsLatitude[0];</span>
<span class="fc" id="L388">                    RationalNumber gpsLatitudeMinutes = gpsLatitude[1];</span>
<span class="fc" id="L389">                    RationalNumber gpsLatitudeSeconds = gpsLatitude[2];</span>

                    //obtain latitude ref
<span class="fc" id="L392">                    TiffField gpsLatitudeRefField = metadata.findEXIFValue(</span>
                        TiffConstants.GPS_TAG_GPS_LATITUDE_REF);
                    //set north by default
<span class="fc" id="L395">                    String gpsLatitudeRef = TiffConstants.</span>
                            GPS_TAG_GPS_LATITUDE_REF_VALUE_NORTH;
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">                    if (gpsLatitudeRefField != null) {</span>
<span class="fc" id="L398">                        gpsLatitudeRef = (String)gpsLatitudeRefField.getValue();</span>
                    }
<span class="fc" id="L400">                    double tmp = gpsLatitudeDegrees.doubleValue() + </span>
<span class="fc" id="L401">                            gpsLatitudeMinutes.doubleValue() / 60.0 +</span>
<span class="fc" id="L402">                            gpsLatitudeSeconds.doubleValue() / 3600.0;</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">                    if (!gpsLatitudeRef.toUpperCase().contains(</span>
                            TiffConstants.GPS_TAG_GPS_LATITUDE_REF_VALUE_NORTH.
<span class="fc" id="L405">                            toUpperCase())) {</span>
<span class="nc" id="L406">                        tmp *= -1.0;</span>
                    }
<span class="fc" id="L408">                    latitude = tmp;</span>
                }
            }
            
            //gps longitude
<span class="fc" id="L413">            Double longitude = null;</span>
<span class="fc" id="L414">            TiffField gpsLongitudeField = metadata.findEXIFValue(</span>
                    TiffConstants.GPS_TAG_GPS_LONGITUDE);            
<span class="pc bpc" id="L416" title="1 of 4 branches missed.">            if (gpsLongitudeField != null &amp;&amp;</span>
                    gpsLongitudeField.fieldType instanceof FieldTypeRational) {
<span class="fc" id="L418">                RationalNumber gpsLongitude[] = (RationalNumber[])</span>
<span class="fc" id="L419">                        gpsLongitudeField.getValue();</span>
                            
<span class="pc bpc" id="L421" title="2 of 4 branches missed.">                if (gpsLongitude != null &amp;&amp; gpsLongitude.length &gt;= 3) {</span>
<span class="fc" id="L422">                    RationalNumber gpsLongitudeDegrees = gpsLongitude[0];</span>
<span class="fc" id="L423">                    RationalNumber gpsLongitudeMinutes = gpsLongitude[1];</span>
<span class="fc" id="L424">                    RationalNumber gpsLongitudeSeconds = gpsLongitude[2];</span>

                    //obtain longitude ref
<span class="fc" id="L427">                    TiffField gpsLongitudeRefField = metadata.findEXIFValue(</span>
                        TiffConstants.GPS_TAG_GPS_LONGITUDE_REF);
                    //set east by default
<span class="fc" id="L430">                    String gpsLongitudeRef = TiffConstants.</span>
                            GPS_TAG_GPS_LONGITUDE_REF_VALUE_EAST;
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">                    if (gpsLongitudeRefField != null) {</span>
<span class="fc" id="L433">                        gpsLongitudeRef = (String)gpsLongitudeRefField.</span>
<span class="fc" id="L434">                                getValue();                    </span>
                    }
<span class="fc" id="L436">                    double tmp = gpsLongitudeDegrees.doubleValue() +</span>
<span class="fc" id="L437">                                gpsLongitudeMinutes.doubleValue() / 60.0 +</span>
<span class="fc" id="L438">                                gpsLongitudeSeconds.doubleValue() / 3600.0;</span>
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">                    if (!gpsLongitudeRef.toUpperCase().contains(</span>
                            TiffConstants.GPS_TAG_GPS_LONGITUDE_REF_VALUE_EAST.
<span class="fc" id="L441">                            toUpperCase())) {</span>
<span class="nc" id="L442">                        tmp *= -1.0;</span>
                    }                
<span class="fc" id="L444">                    longitude = tmp;</span>
                }
            }
            
            //gps altitude
<span class="fc" id="L449">            Double altitude = null;</span>
<span class="fc" id="L450">            TiffField gpsAltitudeField = metadata.findEXIFValue(</span>
                    TiffConstants.GPS_TAG_GPS_ALTITUDE);
<span class="pc bpc" id="L452" title="1 of 4 branches missed.">            if (gpsAltitudeField != null &amp;&amp;</span>
                    gpsAltitudeField.fieldType instanceof FieldTypeRational) {
<span class="fc" id="L454">                RationalNumber number = </span>
<span class="fc" id="L455">                        (RationalNumber)gpsAltitudeField.getValue();</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L457">                    double tmp = number.doubleValue();</span>

                    //check if above or under sea level
<span class="fc" id="L460">                    TiffField gpsAltitudeRefField = metadata.findEXIFValue(</span>
                            TiffConstants.GPS_TAG_GPS_ALTITUDE_REF);
<span class="fc" id="L462">                    Integer above = TiffConstants.</span>
                            GPS_TAG_GPS_ALTITUDE_REF_VALUE_ABOVE_SEA_LEVEL;
<span class="pc bpc" id="L464" title="2 of 4 branches missed.">                    if (gpsAltitudeRefField != null &amp;&amp;</span>
                            gpsAltitudeRefField.fieldType instanceof FieldTypeShort) {
<span class="nc" id="L466">                        above = (Integer)gpsAltitudeRefField.getValue();</span>
                    }   
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">                    if (above != TiffConstants.</span>
                            GPS_TAG_GPS_ALTITUDE_REF_VALUE_ABOVE_SEA_LEVEL) {
                        //below sea level
<span class="nc" id="L471">                        tmp *= -1.0;</span>
                    }
<span class="fc" id="L473">                    altitude = tmp;</span>
                }
            }
            
<span class="fc" id="L477">            GPSCoordinates coordinates = null;</span>
<span class="pc bpc" id="L478" title="1 of 6 branches missed.">            if (latitude != null &amp;&amp; longitude != null &amp;&amp; altitude != null) {</span>
<span class="fc" id="L479">                coordinates = new GPSCoordinates(latitude, longitude, altitude);</span>
<span class="pc bpc" id="L480" title="2 of 6 branches missed.">            } else if (latitude != null &amp;&amp; longitude != null &amp;&amp; </span>
                        altitude == null) {
<span class="fc" id="L482">                coordinates = new GPSCoordinates(latitude, longitude);</span>
            }
            
<span class="fc bfc" id="L485" title="All 2 branches covered.">            if (coordinates != null) {</span>
<span class="fc" id="L486">                result.setLocation(coordinates);</span>
            }
            
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">            if (result.getOrientation() != null) {</span>
                //if orientation is available as exif data, check if width and
                //height need to be exchangd
<span class="fc bfc" id="L492" title="All 2 branches covered.">                switch (result.getOrientation()) {</span>
                    case RIGHT_TOP: 
                        //orientation == 6 (clockwise 270ยบ)
                    case LEFT_BOTTOM: 
                        //orientation == 8 (clockwise 90ยบ)
                        //width and height must be exchanged
<span class="fc" id="L498">                        result.setWidth(imageInfo.getHeight());</span>
<span class="fc" id="L499">                        result.setHeight(imageInfo.getWidth());</span>
<span class="fc" id="L500">                        break;                  </span>
                    default:
                        break;
                }
            }  
            
            //Get artist
<span class="fc" id="L507">            TiffField artistField = metadata.findEXIFValue(</span>
                    TiffTagConstants.TIFF_TAG_ARTIST);
<span class="fc" id="L509">            String artist = null;</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">            if (artistField != null) {</span>
<span class="nc" id="L511">                artist = artistField.getValueDescription();</span>
            }
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">            if (artist != null) {</span>
<span class="nc" id="L514">                result.setArtist(trim(artist));</span>
            }
            
            //Get copyright
<span class="fc" id="L518">            TiffField copyrightField = metadata.findEXIFValue(</span>
                    TiffTagConstants.TIFF_TAG_COPYRIGHT);
<span class="fc" id="L520">            String copyright = null;</span>
<span class="pc bpc" id="L521" title="1 of 2 branches missed.">            if (copyrightField != null) {</span>
<span class="nc" id="L522">                copyright = copyrightField.getValueDescription();</span>
            }
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">            if (copyright != null) {</span>
<span class="nc" id="L525">                result.setCopyright(trim(copyright));</span>
            }
            
            //Get document name
<span class="fc" id="L529">            TiffField documentNameField = metadata.findEXIFValue(</span>
                    TiffTagConstants.TIFF_TAG_DOCUMENT_NAME);
<span class="fc" id="L531">            String documentName = null;</span>
<span class="pc bpc" id="L532" title="1 of 2 branches missed.">            if (documentNameField != null) {</span>
<span class="nc" id="L533">                documentName = artistField.getValueDescription();</span>
            }
<span class="pc bpc" id="L535" title="1 of 2 branches missed.">            if (documentName != null) {</span>
<span class="nc" id="L536">                result.setDocumentName(trim(documentName));</span>
            }
            
            //Get host computer
<span class="fc" id="L540">            TiffField hostComputerField = metadata.findEXIFValue(</span>
                    TiffTagConstants.TIFF_TAG_HOST_COMPUTER);
<span class="fc" id="L542">            String hostComputer = null;</span>
<span class="fc bfc" id="L543" title="All 2 branches covered.">            if (hostComputerField != null) {</span>
<span class="fc" id="L544">                hostComputer = hostComputerField.getValueDescription();</span>
            }
<span class="fc bfc" id="L546" title="All 2 branches covered.">            if (hostComputer != null) {</span>
<span class="fc" id="L547">                result.setHostComputer(trim(hostComputer));</span>
            }
            
            //Get image description
<span class="fc" id="L551">            TiffField imageDescriptionField = metadata.findEXIFValue(</span>
                    TiffTagConstants.TIFF_TAG_IMAGE_DESCRIPTION);
<span class="fc" id="L553">            String imageDescription = null;</span>
<span class="fc bfc" id="L554" title="All 2 branches covered.">            if (imageDescriptionField != null) {</span>
<span class="fc" id="L555">                imageDescription = imageDescriptionField.getValueDescription();</span>
            }
<span class="fc bfc" id="L557" title="All 2 branches covered.">            if (imageDescription != null) {</span>
<span class="fc" id="L558">                result.setImageDescription(trim(imageDescription));</span>
            }
            
            //Get software
<span class="fc" id="L562">            TiffField softwareField = metadata.findEXIFValue(</span>
                    TiffTagConstants.TIFF_TAG_SOFTWARE);
<span class="fc" id="L564">            String software = null;</span>
<span class="fc bfc" id="L565" title="All 2 branches covered.">            if (softwareField != null) {</span>
<span class="fc" id="L566">                software = softwareField.getValueDescription();</span>
            }
<span class="fc bfc" id="L568" title="All 2 branches covered.">            if (software != null) {</span>
<span class="fc" id="L569">                result.setSoftware(trim(software));</span>
            }
            
            //Get target printer
<span class="fc" id="L573">            TiffField targetPrinterField = metadata.findEXIFValue(</span>
                    TiffTagConstants.TIFF_TAG_TARGET_PRINTER);
<span class="fc" id="L575">            String targetPrinter = null;</span>
<span class="pc bpc" id="L576" title="1 of 2 branches missed.">            if (targetPrinterField != null) {</span>
<span class="nc" id="L577">                targetPrinter = targetPrinterField.getValueDescription();</span>
            }
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">            if (targetPrinter != null) {</span>
<span class="nc" id="L580">                result.setTargetPrinter(trim(targetPrinter));</span>
            }
            
            //Get camera serial number
<span class="fc" id="L584">            TiffField cameraSerialNumberField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_CAMERA_SERIAL_NUMBER);
<span class="fc" id="L586">            String cameraSerialNumber = null;</span>
<span class="pc bpc" id="L587" title="1 of 2 branches missed.">            if (cameraSerialNumberField != null) {</span>
<span class="nc" id="L588">                cameraSerialNumber = </span>
<span class="nc" id="L589">                        cameraSerialNumberField.getValueDescription();</span>
            }
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">            if (cameraSerialNumber != null) {</span>
<span class="nc" id="L592">                result.setCameraSerialNumber(trim(cameraSerialNumber));</span>
            }
            
            //Get digital zoom ratio
<span class="fc" id="L596">            TiffField digitalZoomRatioField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_DIGITAL_ZOOM_RATIO);
<span class="pc bpc" id="L598" title="1 of 4 branches missed.">            if (digitalZoomRatioField != null &amp;&amp; </span>
                    digitalZoomRatioField.fieldType instanceof FieldTypeRational) {
<span class="fc" id="L600">                RationalNumber number = </span>
<span class="fc" id="L601">                        (RationalNumber)digitalZoomRatioField.getValue();</span>
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L603">                    result.setDigitalZoomRatio(number.doubleValue());</span>
                }
            }
            
            //Get exposure time
<span class="fc" id="L608">            TiffField exposureTimeField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_EXPOSURE_TIME);
<span class="pc bpc" id="L610" title="1 of 4 branches missed.">            if (exposureTimeField != null &amp;&amp;</span>
                    exposureTimeField.fieldType instanceof FieldTypeRational) {
<span class="fc" id="L612">                RationalNumber number =</span>
<span class="fc" id="L613">                        (RationalNumber)exposureTimeField.getValue();</span>
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L615">                    result.setExposureTime(number.doubleValue());</span>
                }
            }
            
            //Get flash
<span class="fc" id="L620">            TiffField flashField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_FLASH);
<span class="pc bpc" id="L622" title="1 of 4 branches missed.">            if (flashField != null &amp;&amp;</span>
                    flashField.fieldType instanceof FieldTypeShort) {
<span class="fc" id="L624">                Integer number = (Integer)flashField.getValue();</span>
<span class="pc bpc" id="L625" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L626">                    result.setFlash(Flash.fromValue(number));</span>
                }
            }
            
            //Get flash energy
<span class="fc" id="L631">            TiffField flashEnergyField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_FLASH_ENERGY);
<span class="pc bpc" id="L633" title="3 of 4 branches missed.">            if (flashEnergyField != null &amp;&amp;</span>
                    flashEnergyField.fieldType instanceof FieldTypeRational) {
<span class="nc" id="L635">                RationalNumber number =</span>
<span class="nc" id="L636">                        (RationalNumber)flashEnergyField.getValue();</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">                if (number != null) {</span>
<span class="nc" id="L638">                    result.setFlashEnergy(number.doubleValue());</span>
                }
            }
            
            //Get F number
<span class="fc" id="L643">            TiffField fNumberField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_FNUMBER);
<span class="pc bpc" id="L645" title="1 of 4 branches missed.">            if (fNumberField != null &amp;&amp; </span>
                    fNumberField.fieldType instanceof FieldTypeRational) {
<span class="fc" id="L647">                RationalNumber number = (RationalNumber)fNumberField.getValue();</span>
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L649">                    result.setFNumber(number.doubleValue());</span>
                }
            }
            
            //Get focal length in 35mm film
<span class="fc" id="L654">            TiffField focalLength35mmFormatField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_FOCAL_LENGTH_IN_35MM_FORMAT);
<span class="pc bpc" id="L656" title="3 of 4 branches missed.">            if (focalLength35mmFormatField != null &amp;&amp;</span>
                    focalLength35mmFormatField.fieldType instanceof FieldTypeRational) {
<span class="nc" id="L658">                RationalNumber number = </span>
<span class="nc" id="L659">                        (RationalNumber)focalLength35mmFormatField.getValue();</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">                if (number != null) {</span>
<span class="nc" id="L661">                    result.setFocalLengthIn35mmFilm(number.doubleValue());</span>
                }
            }
            
            //Get unique camera model
<span class="fc" id="L666">            TiffField uniqueCameraModelField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_UNIQUE_CAMERA_MODEL);
<span class="fc" id="L668">            String uniqueCameraModel = null;</span>
<span class="pc bpc" id="L669" title="1 of 2 branches missed.">            if (uniqueCameraModelField != null) {</span>
<span class="nc" id="L670">                uniqueCameraModel = modelField.getValueDescription();</span>
            }
<span class="pc bpc" id="L672" title="1 of 2 branches missed.">            if (uniqueCameraModel != null) {</span>
<span class="nc" id="L673">                result.setUniqueCameraModel(trim(uniqueCameraModel));</span>
            }
            
            //Get subject distance
<span class="fc" id="L677">            TiffField subjectDistanceField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_SUBJECT_DISTANCE);
<span class="pc bpc" id="L679" title="3 of 4 branches missed.">            if (subjectDistanceField != null &amp;&amp;</span>
                    subjectDistanceField.fieldType instanceof FieldTypeRational) {
<span class="nc" id="L681">                RationalNumber number = </span>
<span class="nc" id="L682">                        (RationalNumber)subjectDistanceField.getValue();</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">                if (number != null) {</span>
<span class="nc" id="L684">                    result.setSubjectDistance(number.doubleValue());</span>
                }
            }
            
            //Get shutter speed value
<span class="fc" id="L689">            TiffField shutterSpeedField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_SHUTTER_SPEED_VALUE);
<span class="pc bpc" id="L691" title="1 of 4 branches missed.">            if (shutterSpeedField != null &amp;&amp;</span>
                    shutterSpeedField.fieldType instanceof FieldTypeRational) {
<span class="fc" id="L693">                RationalNumber number =</span>
<span class="fc" id="L694">                        (RationalNumber)shutterSpeedField.getValue();</span>
<span class="pc bpc" id="L695" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L696">                    result.setShutterSpeedValue(number.doubleValue());</span>
                }
            }
            
            //Get ISO
<span class="fc" id="L701">            TiffField isoField = metadata.findEXIFValue(</span>
                    ExifTagConstants.EXIF_TAG_ISO);
<span class="pc bpc" id="L703" title="1 of 4 branches missed.">            if (isoField != null &amp;&amp;</span>
                    isoField.fieldType instanceof FieldTypeShort) {
<span class="fc" id="L705">                Integer number = (Integer)isoField.getValue();</span>
<span class="pc bpc" id="L706" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L707">                    result.setISO(number);</span>
                }
            }            
            
<span class="nc" id="L711">        } catch (ImageReadException e) {</span>
<span class="nc" id="L712">            throw new InvalidImageException(e);</span>
<span class="fc" id="L713">        }</span>
<span class="fc" id="L714">    }</span>
    
    /**
     * Trims leading and ending apostrophes from provided string.
     * @param s string to be processed.
     * @return trimmed string.
     */
    private String trim(String s) {
<span class="fc" id="L722">        String result = null;</span>
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">        if (s != null) {</span>
<span class="fc" id="L724">            result = s;</span>
<span class="pc bpc" id="L725" title="1 of 2 branches missed.">            if (s.startsWith(&quot;'&quot;)) {</span>
<span class="fc" id="L726">                result = result.substring(1);</span>
            }
<span class="pc bpc" id="L728" title="1 of 2 branches missed.">            if (s.endsWith(&quot;'&quot;)) {</span>
<span class="fc" id="L729">                result = result.substring(0, result.length() - 1);</span>
            }
        }
<span class="fc" id="L732">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>